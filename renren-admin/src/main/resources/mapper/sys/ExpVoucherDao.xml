<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="io.renren.modules.sys.dao.ExpVoucherDao">

	<!-- 可根据自己的需求，是否要使用 -->
    <resultMap type="io.renren.modules.sys.entity.ExpVoucherEntity" id="expVoucherMap">
        <result property="id" column="id"/>
        <result property="voucherRemark" column="voucher_remark"/>
        <result property="voucherCode" column="voucher_code"/>
        <result property="twoLevelCoding" column="two_level_coding"/>
        <result property="twoLevelName" column="two_level_name"/>
        <result property="customerName" column="customer_name"/>
        <result property="waybillNumber" column="waybill_number"/>
        <result property="destinationDot" column="destination_dot"/>
        <result property="debtorMoney" column="debtor_money"/>
        <result property="lenderMoney" column="lender_money"/>
        <result property="debtorWeight" column="debtor_weight"/>
        <result property="lenderWeight" column="lender_weight"/>
        <result property="customerCode" column="customer_code"/>
        <result property="createDate" column="create_date"/>
        <result property="deptId" column="dept_id"/>
    </resultMap>
     <insert id="saveList" parameterType="io.renren.modules.sys.entity.ExpVoucherEntity">
     INSERT INTO exp_voucher
		(
				`voucher_remark`
				,voucher_code
				,`two_level_coding`
				,`two_level_name`
				,`customer_name`
				,`waybill_number`
				,`destination_dot`
				,`debtor_money`
				,`lender_money`
				,`debtor_weight`
				,`lender_weight`
				,`customer_code`
				,`create_date`
				,`dept_id`
				 
		)
		VALUES
		<foreach collection="list" item="item" index="index" separator=",">
		(
				 #{item.voucherRemark}
				,#{item.voucherCode}
				,#{item.twoLevelCoding}
				,#{item.twoLevelName}
				,#{item.customerName}
				,#{item.waybillNumber}
				,#{item.destinationDot}
				,#{item.debtorMoney}
				,#{item.lenderMoney}
				,#{item.debtorWeight}
				,#{item.lenderWeight}
				,#{item.customerCode}
				,#{item.createDate}
				,#{item.deptId}
				 
		)
		</foreach>
     </insert>
      <!--计算毛利 -->
       <select id="selectPageMy" resultType="io.renren.modules.sys.entity.ExpVoucherEntity">
			SELECT
				v.customer_code,
				v.customer_name,
				v.waybill_number,
				v.destination_dot,
				v.debtor_weight,
				v.debtor_money,
				len.lender_money,
				v.create_date,
				${baseBil} AS base_bil,
				(
					v.debtor_money - len.lender_money - ${baseBil}
				) AS gross_profit
			FROM
				exp_voucher v
			LEFT JOIN (
				SELECT
					SUM(le.debtor_money) AS lender_money,
					le.waybill_number
				FROM
					exp_voucher le
				WHERE
					le.two_level_coding = '600201'
				GROUP BY
					le.waybill_number
			) AS len ON len.waybill_number = v.waybill_number
			<where>
			 <if test="null!=filter and ''!=filter">
				${filter}
		     </if>
			AND v.two_level_coding = '112201'
			 <if test="null!=startDates and ''!=startDates">
			AND DATE_FORMAT(v.create_date, '%Y-%m-%d')&gt;=#{startDates}
			</if> 
			<if test="null!=endDates and ''!=endDates">
			AND DATE_FORMAT(v.create_date, '%Y-%m-%d')&lt;=#{endDates}
			</if>
			AND v.debtor_money > 0
			</where>
		    LIMIT #{currPage},#{limit}
       </select>
       <!--时间段内毛收入数量-->
        <select id="selectCountMy" resultType="Integer">
           SELECT
				count(*)
			FROM
				exp_voucher v
			<where>
			 <if test="null!=filter and ''!=filter">
				${filter}
		     </if>
				AND v.two_level_coding = '112201'
				 <if test="null!=startDates and ''!=startDates">
				AND DATE_FORMAT(v.create_date, '%Y-%m-%d')&gt;=#{startDates}
				</if> 
				<if test="null!=endDates and ''!=endDates">
				AND DATE_FORMAT(v.create_date, '%Y-%m-%d')&lt;=#{endDates}
				</if>
				AND v.debtor_money > 0
			</where>
        </select>
        <!-- 毛收入汇总 -->
        <select id="SelectGrossProfitSum" resultType="map">
		   SELECT 
			     count(v.waybill_number) AS count,
				 sum(v.debtor_money) AS debtorMoney,
				 sum(len.lender_money) AS lenderMoney,
				 ${baseBil} AS baseBil,
				 sum(
					v.debtor_money - len.lender_money - ${baseBil}
				) AS grossProfit
			FROM
				exp_voucher v
			LEFT JOIN (
				SELECT
					SUM(le.debtor_money) AS lender_money,
					le.waybill_number
				FROM
					exp_voucher le
				WHERE
					le.two_level_coding = '600201'
				GROUP BY
					le.waybill_number
			) AS len ON len.waybill_number = v.waybill_number
			
			<where>
				 <if test="null!=filter and ''!=filter">
					${filter}
			     </if>
			     AND v.two_level_coding = '112201' 
			     AND v.debtor_money > 0 
			     <if test="null!=customer and ''!=customer">
			         AND (v.customer_code=#{customer} OR v.customer_name=#{customer})
			     </if> 
			     <if test="null!=weight and 0!=weight">
			        AND debtor_weight=#{weight}
			     </if> 
			     <if test="null!=province and ''!=province">
			        AND v.destination_dot=#{province}
			     </if> 
		     </where>
		     GROUP BY v.two_level_coding
			     <if test="null!=customer and ''!=customer">
			        ,v.customer_code
			     </if> 
			     <if test="null!=weight and 0!=weight">
			       ,debtor_weight
			     </if> 
			     <if test="null!=province and ''!=province">
			        ,v.destination_dot
			     </if> 
        </select>
</mapper>